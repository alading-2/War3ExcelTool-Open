# War3ExcelTool 优化方案总结 (基于深度思考)

本次优化的核心目标是增强 `War3ExcelTool` 的灵活性和功能性，主要包括以下几个方面：

## 1. 运行模式分离 (`main.py`)

- **目标:** 支持无 UI 的命令行执行和传统的 GUI 交互执行。
- **实现:**
  - 使用 `argparse` 解析命令行参数。
  - **命令行模式:**
    - 必须参数: `-i` (Excel 输入目录/文件), `-o` (基础输出目录)。
    - 可选参数:
      - `--ini-input` / `-ii`: 指定 Ini 输入文件或目录 (用于 Ini->Excel)。
      - `--to-ts`: 启用 Excel -> TS 转换。
      - `--to-lua`: 启用 Excel -> Lua 转换。
      - `--to-ini`: 启用 Excel -> Ini 转换。
      - `--ini-to-excel`: 启用 Ini -> Excel 转换。
      - (可考虑 `--all-excel-out` 启用所有 Excel->\* 转换)。
    - 检测到命令行参数时，构建 `config` 对象，直接调用核心处理逻辑，**不启动 Qt 应用**。
  - **GUI 模式:**
    - 无需命令行参数启动。
    - 正常初始化 `QApplication` 和 `MainWindow`。
    - 用户通过 UI 配置参数并点击按钮触发转换。

## 2. 核心逻辑抽象

- **目标:** 将转换过程的核心逻辑与 UI 和命令行入口解耦。
- **实现:**
  - 创建 `src/core/processor.py`。
  - 定义核心函数 `process_files(config: dict)`，接收包含所有配置项的字典。
  - `process_files` 负责：
    - 根据 `config` 查找输入文件 (Excel 和/或 Ini)。
    - 调用相应的解析器。
    - 调用相应的生成器/写入器。
    - 处理文件写入和目录创建。
    - 返回处理结果或状态。
  - `main.py` (命令行模式) 和 `ConversionWorker` (GUI 模式) 都调用 `process_files`。

## 3. 功能扩展框架

- **目标:** 为新增的 Excel -> Lua, Excel -> Ini, Ini -> Excel 转换功能搭建基础框架。
- **实现:**
  - **Ini->Excel 特殊处理:**
    - 明确其输入源是 `.ini` 文件，使用 `--ini-input` 参数或独立的 UI 输入控件。
    - 其处理逻辑独立于 Excel 文件的遍历循环。
  - **并发执行 (同源):** 对于同一个输入的 Excel 文件，如果勾选了多种输出类型 (TS, Lua, Ini)，应一次读取，分别生成。
  - **新模块规划:**
    - `src/core/lua_generator.py`
    - `src/core/ini_generator.py`
    - `src/core/ini_parser.py`
    - `src/core/excel_writer.py` (可能依赖 `openpyxl` 或 `pandas`)
  - **模板考虑:** 评估 Lua 和 Ini 生成是否需要类似 TS 的模板机制。

## 4. UI 界面 (`MainWindow`) 调整

- **目标:** 提供用户友好的界面来配置新功能。
- **实现:**
  - **输入区域:**
    - 保留 "输入目录" (Excel)。
    - 新增 "INI 输入" 区域 (标签, `QLineEdit`, `QPushButton`)，默认隐藏。
  - **输出区域:**
    - 将 "输出目录" 标签改为 "基础输出目录"。
  - **功能选择区域:**
    - 新增 `QGroupBox` ("转换选项")。
    - 内部包含 `QCheckBox`: "Excel -> TypeScript", "Excel -> Lua", "Excel -> Ini", "Ini -> Excel"。
  - **交互逻辑:**
    - 当 "Ini -> Excel" 复选框状态改变时，切换 "INI 输入" 区域的可见性。

## 5. 输出目录结构

- **目标:** 规范化输出文件的存放位置。
- **实现:**
  - 定义基础输出目录 (`base_output_dir`)。
  - 所有输出文件根据类型放入子目录：
    - `os.path.join(base_output_dir, "output", "ts")`
    - `os.path.join(base_output_dir, "output", "lua")`
    - `os.path.join(base_output_dir, "output", "ini")`
    - `os.path.join(base_output_dir, "output", "excel")` (用于 Ini->Excel 的输出)
  - 更新 `src/utils/file_utils.py` 中的 `ensure_directory` 和路径创建逻辑，以支持按需创建这些子目录。

## 6. 配置管理 (`ConfigManager`) 扩展

- **目标:** 持久化新功能的配置。
- **实现:**
  - 在 `DEFAULT_CONFIG` (位于 `src/utils/config_manager.py`) 和 `config.json` 中添加新键：
    - `convert_to_lua: bool` (default: `False`)
    - `convert_to_ini: bool` (default: `False`)
    - `convert_ini_to_excel: bool` (default: `False`)
    - `ini_input_path: str` (default: `""`)
  - 更新 `MainWindow` 中的 `load_config` 和 `save_config` 方法，以读取/写入这些新配置项对应的 UI 控件状态。

## 7. 后台任务 (`ConversionWorker`) 重构

- **目标:** 使后台线程能够执行所有类型的转换。
- **实现:**
  - `__init__` 接收包含所有配置的 `config` 对象。
  - `run` 方法:
    - 从 `config` 中获取所有设置。
    - 调用核心处理逻辑 `process_files(config)`。
    - （或者，如果 `process_files` 粒度不够细）:
      - 检查启用的 Excel->\* 类型，若有，则查找 Excel 文件并循环处理，调用相应生成器。
      - 检查是否启用 Ini->Excel，若启用，则查找 Ini 文件并循环处理，调用 Ini 解析器和 Excel 生成器。
  - 调整 `progress_updated` 信号的发送逻辑，以反映处理 Excel 和 Ini 文件的总进度。

## 8. 其他注意事项

- **依赖管理:** 如果 `excel_writer.py` 使用 `openpyxl` 或 `pandas`，更新 `requirements.txt` 和 `setup.py`。
- **错误处理:** 为新模块添加健壮的错误处理和日志记录。
- **测试:** 为新功能编写单元测试
- **文档:** 更新 `README.md`，说明新功能、命令行用法和 UI 变化。
- **Ini 格式约定:** 需要明确 Ini->Excel 功能所期望的输入 `.ini` 文件格式。
- **Lua/Ini 输出约定:** 需要定义 Excel->Lua/Ini 生成的目标文件结构。
