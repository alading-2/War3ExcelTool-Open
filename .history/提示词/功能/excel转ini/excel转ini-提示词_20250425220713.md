## excel 转 ini 功能 AI 开发提示词（Prompt）

### 1. 项目背景

本项目旨在实现一个 Python 工具，自动将多个 Excel 表格中的物编数据，批量转换为 war3 ini 格式文件，并生成 TypeScript 映射文件。需兼容白泽框架下的特殊表格和通用物编表格，支持模板驱动、id 自动生成、类型判断、合并、错误追踪、输出路径等功能。

### 2. 物编表格识别规则

- 白泽 table 文件：文件名为 table，sheet 名为 unit/ability/item，需转化为对应 ini。
- 通用物编表格：sheet 的第二行 key 有 id 和\_parent，需转化为 ini，文件名无要求，sheet 名有要求，要求是 ini_parser.py 的 OBJECT_TYPE_MAPPING 里面包含的内容。
- 解析 excel 时，需记录所有需转化的 excel 文件及 sheet，便于后续合并。

### 3. 字段映射与处理

- excel 字段与 ini 模板字段小写匹配，匹配不上则忽略。
- 只处理以下特殊字段：
- cool1：写入时需除以 100
- acquire：若为 0，则 acquire=0，weapsOn=0；否则 acquire=值，weapsOn=1
- 其他如 collision、scale、spd 等，直接写入
- 仅处理上述特殊字段，不考虑后续扩展。

### 4. 类型判断规则

- 类型判断参考 ExcelParser 的 infer_type_single。
- war3ini 不支持科学计数法。
- 双引号包裹的内容一律视为字符串（即使内容为数字，如"123"）。
- 其他情况按数字/字符串自动判断。

### 5. id 生成与命名规则

- war3 物编 id 采用 62 进制，4 位，不足补 0，需实现 10 进制与 62 进制互转函数。
- 各类型 id 生成规则详见需求文档，严格按规则生成。
- 基础命令 id 全局共用，自动取余。

### 6. ini 模板与 section 生成

- 各类型（unit/ability/item）均有对应模板，按模板生成 section 并填充字段。
- 特殊类型（如瞭望塔、物品技能等）有专用模板和字段处理规则。
- section 内容需记录来源（excel 文件、sheet、section 名），便于错误追踪。

### 7. 合并与冲突处理

- 同类型 ini 需合并为一个文件（如 unit.ini）。
- 合并时遇到重复 section（以 war3 物编 id 为 key），不覆盖，直接跳过，并记录详细错误信息（含来源）。

### 8. 输出与文件管理

- ini 文件输出到“输出路径+output+ini”目录，文件名按类型命名（如 unit.ini）。
- 若设置了 ini_output 路径，需额外复制一份到该目录。
- 需生成 ts 映射文件，格式参考已有 ts 文件，内容为名字与物编 id 的映射。

### 9. 辅助参数与配置

- 支持“玩家数量”辅助参数，影响技能物编生成数量，默认 5。
- 其他参数如输出路径、ini_output 等需支持配置。

### 10. 错误与日志

- 需详细记录每条数据的来源（excel 文件、sheet、section），便于错误追踪。
- 合并冲突、字段缺失、类型错误等需有详细报错，建议支持日志文件输出（可选）。

### 11. 其他

- 仅处理上述特殊字段和规则，不考虑后续扩展和多语言。
- 性能、单元测试、插件式扩展等暂不考虑，但建议后续可补充。
- 所有异常需捕获并打印堆栈和当前处理的 excel 文件、sheet、section、参数等，方便定位问题。

---

## 方案具体执行步骤

### 阶段一：需求文档与 README 完善

1. 在项目根目录创建/完善 README.md，详细描述功能、输入输出格式、参数说明、使用方法、注意事项。
2. 列出所有支持的 excel 格式、字段映射、模板规则、输出示例。
3. 完成后请暂停，等待用户审查反馈。

### 阶段二：excel 解析与物编表格识别

1. 实现 excel 文件批量读取，支持多文件多 sheet。
2. 按规则识别需转化的物编表格（白泽 table 文件的 unit/ability/item sheet，或第二行 key 有 id 和\_parent 的 sheet）。
3. 记录所有需转化的 excel 文件及 sheet，便于后续处理。
4. 完成后请暂停，等待用户审查反馈。

### 阶段三：ini 模板解析与字段映射

1. 解析 ini 模板文件，按类型（unit/ability/item）加载模板。
2. 实现 excel 字段与模板字段的小写匹配，忽略多余字段。
3. 实现特殊字段处理逻辑（如 cool1/100、acquire/weapsOn 等）。
4. 完成后请暂停，等待用户审查反馈。

### 阶段四：id 生成与类型判断

1. 实现 10 进制与 62 进制互转函数，确保 id 生成符合 4 位、补 0 规则。
2. 按类型规则生成物编 id，确保唯一性和正确性。
3. 实现类型判断函数，参考 ExcelParser 的 infer_type_single，严格按规则处理双引号、科学计数法等。
4. 完成后请暂停，等待用户审查反馈。

### 阶段五：section 生成与合并

1. 按模板和字段映射生成 ini section，填充所有字段。
2. section 内容需记录来源（excel 文件、sheet、section 名）。
3. 合并同类型 ini，遇到重复 section 不覆盖，跳过并记录详细错误信息。
4. 完成后请暂停，等待用户审查反馈。

### 阶段六：输出与 ts 映射文件生成

1. 将合并后的 ini 文件输出到“输出路径+output+ini”目录，文件名按类型命名。
2. 若设置了 ini_output 路径，额外复制一份到该目录。
3. 生成 ts 映射文件，内容为名字与物编 id 的映射，格式参考已有 ts 文件。
4. 完成后请暂停，等待用户审查反馈。

### 阶段七：异常处理与日志

1. 所有异常需捕获并打印堆栈和当前处理的 excel 文件、sheet、section、参数等。
2. 合并冲突、字段缺失、类型错误等需有详细报错，建议支持日志文件输出（可选）。
3. 完成后请暂停，等待用户审查反馈。

### 阶段八：最终测试与文档完善

1. 编写典型用例，测试各类 excel、模板、字段、合并、输出等功能。
2. 补充完善 README 和使用文档，确保用户易于理解和使用。
3. 完成后请暂停，等待用户最终确认。

---

每个阶段完成后都要暂停，等待用户审查和反馈，确认无误后再进入下一阶段。遇到需求不清、实现难点、异常情况要主动与用户沟通，提出优化建议。

如需进一步细化某一阶段的任务或有其他特殊要求，请随时补充说明。
