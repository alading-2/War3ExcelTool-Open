# Role

你是一名精通 Python 的高级工程师，负责为一个 Excel 数据处理工具添加新功能：将 Excel 表格数据自动转换为 War3 物编 INI 代码。

# Goal

实现一个 Python 模块/函数，该模块/函数接收 `processor.py` 解析后的 Excel 数据，并根据预设规则生成符合 War3 规范的 `.ini` 文件和相应的 TypeScript ID 映射文件。

# Input Data & Resources

1. **Parsed Excel Data:** 从 `processor.py` 获取的已解析数据结构（假设为一个字典或类似结构，包含各 Sheet 的数据）。
2. **INI Template:** 读取并解析 `resource/resource/excel_to_ini/excel_to_ini_template.ini`。
3. **Base Order IDs:** 读取并解析 `resource/resource/excel_to_ini/基础命令id.txt` 存入列表 `order_id_list`。
4. **Field Mapping:** 使用 `resource/resource/editor_info_map.ini` 中的信息进行 Excel 列名到 INI 字段的映射。
5. **Player Count:** 从配置或参数获取玩家数量 (默认为 5)。
6. **INI Output Path:** 从配置或参数获取可选的 INI 文件导出路径 `ini_output`。

# Core Logic (Based on Parsed Data)

1. **Identify Vocation Sheets:** 遍历解析的数据，根据文件名 (`table`) 和 Sheet 名 (`unit`, `ability`, `item` 等，参考 `ini_parser.OBJECT_TYPE_MAPPING`) 或 Sheet 第二行 Key 值 (`id`, `_parent`)，识别需要转换为 INI 的物编表格。记录来源信息 (文件名, Sheet 名)。
2. **Load Templates:** 根据识别的物编类型，加载 `excel_to_ini_template.ini` 中的对应模板 Section。
3. **Generate Base Abilities:** 根据玩家数量、模板和规则 (ID: X/Y/Z+p+x+y, Order ID from list, DataB/C/F, Buttonpos, Name) 生成基础技能 INI Sections。
4. **Generate Other Template Abilities:** 生成建造、移动、物品栏技能的 INI Sections。
5. **Process Excel Data Rows:**
   - 遍历识别出的物编 Sheet 的数据行。
   - 为每行生成一个 INI Section。
   - **Generate ID:** 根据物编类型 (unit/item/ability) 和规则 (如 'h'+n, 'I'+n(62 进制补零), 'A'+n(62 进制补零)) 生成 4 位 ID。
   - **Map Fields:** 将 Excel 列名 (小写) 与 `editor_info_map.ini` 匹配，填充 INI 字段。处理特殊字段 (`cool1`, `acquire`, `model/file`, `way`, `range`, `droppable`, `goldcost` 等)。
   - **Handle Data Types:** 确保输出符合 War3 INI 格式 (字符串加 `""`, 数字直接输出)。
6. **Implement Base62 Conversion:** 提供 `int_to_base62` 和 `base62_to_int` 函数。
7. **Merge INI Data:** 将所有生成的同一类型 (如 `unit`) 的 INI Sections 合并到一个数据结构中。处理 ID 冲突 (跳过并记录错误，包含来源信息)。
8. **Generate TS Mappings:** 根据生成的单位、物品、物品技能数据，创建包含名字和 ID 映射的 `unitid.ts`, `itemid.ts`, `itemabil.ts` 文件。注意 ID 起始值。

# Output

1. **INI Files:** 将合并后的数据写入对应类型的 `.ini` 文件 (e.g., `unit.ini`, `ability.ini`) 到指定输出目录 (`output/ini/`)。
2. **TS Files:** 将 ID 映射写入 `.ts` 文件到指定输出目录 (`output/ts/`)。
3. **Error Log:** 输出合并冲突或其他处理错误的信息。
4. **Copy INIs (Optional):** 如果提供了 `ini_output` 路径，将生成的 INI 文件复制到该路径。

# Constraints & Requirements

- **Simplicity:** 严格利用 `processor.py` 的解析结果，避免重新解析 Excel。代码实现力求简洁高效。
- **Error Handling:** 捕获并记录处理过程中的错误，尤其是 INI 合并冲突，提供详细来源信息。
- **Code Style:** 遵循 PEP 8，使用中文注释，添加必要的文档字符串。
- **Dependencies:** 使用 `configparser` 或兼容库解析 INI 模板。
- **Modularity:** 将核心逻辑封装在独立的函数或类中。

# Optimization Suggestions (Consider if time permits)

- Use efficient data structures for storing/merging INI data.
- Centralize configuration (like `OBJECT_TYPE_MAPPING`, file paths).

简单的项目执行步骤：

1. 准备阶段：

- 创建新的 Python 文件（例如 excel_to_ini_converter.py）。
- 实现必要的辅助函数：
- int_to_base62(n) 和 base62_to_int(s) 用于 ID 转换。
- 函数用于加载和解析 INI 模板 (excel_to_ini_template.ini)。
- 函数用于加载基础命令 ID (基础命令 id.txt) 到列表 order_id_list。
- 函数用于加载字段映射规则 (editor_info_map.ini)。
- (可选) 函数用于格式化 War3 INI 值 (加引号等)。

1. 核心处理与 INI 生成：

- 定义主函数 convert_excel_to_ini(parsed_data, player_count, ini_output_path=None)，接收 processor.py 的解析结果等参数。
- 在该函数内：
- 初始化用于存储各类 INI Section 的数据结构 (例如，ini_data = {'unit': {}, 'ability': {}, ...}) 和错误日志列表。
- 生成模板驱动的 INI： 调用独立函数生成基础技能、建造技能、移动技能、物品栏技能的 INI 数据，并存入 ini_data['ability']。
- 处理 Excel 数据驱动的 INI：
- 遍历 parsed_data，识别物编 Sheet。
- 对每个物编 Sheet，遍历其数据行。
- 为每行数据：
- 生成物编 ID。
- 根据模板和 Excel 数据，结合字段映射规则，创建 INI Section 数据（字典）。
- 尝试将 Section 添加到对应类型的 ini_data 中，处理 ID 冲突（记录错误）。
- 同时收集用于生成 TS 映射的信息（名字和 ID）。

1. 输出与收尾：

- 生成 INI 文件： 遍历 ini_data，将每个类型的 Section 数据写入对应的 .ini 文件到 output/ini/ 目录。
- 生成 TS 文件： 根据收集到的映射信息，生成 unitid.ts, itemid.ts, itemabil.ts 到 output/ts/ 目录。
- 输出错误日志： 将记录的错误信息打印或写入日志文件。
- (可选) 复制 INI 文件： 如果 ini_output_path 有效，将生成的 INI 文件复制过去。
- 在 processor.py 或主流程中调用 convert_excel_to_ini 函数。
